<?php require "../../config/database.php";

session_start();
// This function will populate the comments and comments replies using a loop
// This function will populate the comments and comments replies using a loop
function show_comments($comments,$con) {
    $html = '';

    // Iterate the comments using the foreach loop
    foreach ($comments as $comment) {
        //print_r(array_keys($comment));
        $author = $comment['author_id'];

        $stmt = mysqli_query($con,"SELECT * FROM `GVWA`.`customers` WHERE ID = $author");
        $author = mysqli_fetch_assoc($stmt);

            // Add the comment to the $html variable
            $html .= '
            <div class="comment">
                <div>
                    <h3 class="name">' . $author['username'] . '</h3>
                </div>
                <p class="content">' . $comment['review'] . '</p>
            </div>
            ';
    }
    return $html;
}

// This function is the template for the write comment form
function show_write_comment_form($author_id,$product_id) {
    $html = '
    <div class="write_comment" data-comment-id="' . $author_id . '">
        <form>
            <input name="author_id" type="hidden" value="' . $author_id . '">
            <input name="product_id" type="hidden" value="' . $product_id . '">
            <textarea name="content" placeholder="Write your comment here..." required></textarea>
            <button type="submit">Submit Comment</button>
        </form>
    </div>
    ';
    return $html;
}

// Page ID needs to exist, this is used to determine which comments are for which page
if (isset($_GET['product_id'])) {
    
    $page = $_GET['product_id'];
    // Check if the submitted form variables exist
    if (isset($_POST['author_id'], $_POST['content'])) {

        $author = $_POST['author_id'];
        $content = $_POST['content'];

        echo $author, $content, $page;
        $rating = 1;
        // POST variables exist, insert a new comment into the MySQL comments table (user submitted form)
        $sql = "INSERT INTO reviews (ID,product_ID, author_id, review,rating) VALUES (NULL,$page,$author,'$content',$rating);";
        $stmt = mysqli_query($con,  $sql ) or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );
        exit('Your comment has been submitted!');
    }
    $sql = "SELECT author_id,review FROM reviews WHERE product_ID = $page LIMIT 0,500";
    $stmt = mysqli_query($con,  $sql ) or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );
    
    $comments = array();
    while($row = mysqli_fetch_assoc($stmt))
        {
            $comments[] = $row;
        }
    // Get the total number of comments
    $stmt = mysqli_query($con,"SELECT COUNT(*) AS total_comments FROM reviews WHERE product_ID = $page");
    $comments_info = mysqli_fetch_assoc($stmt);
} else {
    exit('No product ID specified!');
}
?>


<div class="comment_header">
    <span class="total"><?=$comments_info['total_comments']?> comments</span>
    <a href="#" class="write_comment_btn" data-comment-id="1">Write Comment</a>
</div>

<?=show_write_comment_form($_SESSION['user_id'],$_GET['product_id'])?>

<?=show_comments($comments,$con)?>