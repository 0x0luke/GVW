<?php require "../../config/database.php";

session_start();

if (!(isset($_SESSION['id']))){
    echo "Must be signed in to leave a comment";
}
// This function will populate the comments and comments replies using a loop
// This function will populate the comments and comments replies using a loop
function show_comments($comments,$con) {
    $html = '';

    // Iterate the comments using the foreach loop
    foreach ($comments as $comment) {
        //print_r(array_keys($comment));
        $author = $comment['author_id'];

        $stmt = mysqli_query($con,"SELECT * FROM `GVWA`.`customers` WHERE ID = $author");
        $author = mysqli_fetch_assoc($stmt);

            // Add the comment to the $html variable
            $html .= '
            <div class="comment">
                <div>
                    <h3 class="name">' . $author['username'] . '</h3>
                </div>
                <p class="content">' . $comment['review'] . '</p>
            </div>
            ';
    }
    return $html;
}

// This function is the template for the write comment form
function show_write_comment_form($author_id,$product_id) {
    $html = '
    <div class="write_comment" data-comment-id="' . $author_id . '">
        <form>
            <input name="author_id" type="hidden" value="' . $author_id . '">
            <input name="product_id" type="hidden" value="' . $product_id . '">
            <textarea name="content" placeholder="Write your comment here..." required></textarea>
            <button type="submit">Submit Comment</button>
        </form>
    </div>
    ';
    return $html;
}
function xss_clean($data)
{
// Fix &entity\n;
$data = str_replace(array('&amp;','&lt;','&gt;'), array('&amp;amp;','&amp;lt;','&amp;gt;'), $data);
$data = preg_replace('/(&#*\w+)[\x00-\x20]+;/u', '$1;', $data);
$data = preg_replace('/(&#x*[0-9A-F]+);*/iu', '$1;', $data);
$data = html_entity_decode($data, ENT_COMPAT, 'UTF-8');

// Remove any attribute starting with "on" or xmlns
$data = preg_replace('#(<[^>]+?[\x00-\x20"\'])(?:on|xmlns)[^>]*+>#iu', '$1>', $data);

// Remove javascript: and vbscript: protocols
$data = preg_replace('#([a-z]*)[\x00-\x20]*=[\x00-\x20]*([`\'"]*)[\x00-\x20]*j[\x00-\x20]*a[\x00-\x20]*v[\x00-\x20]*a[\x00-\x20]*s[\x00-\x20]*c[\x00-\x20]*r[\x00-\x20]*i[\x00-\x20]*p[\x00-\x20]*t[\x00-\x20]*:#iu', '$1=$2nojavascript...', $data);
$data = preg_replace('#([a-z]*)[\x00-\x20]*=([\'"]*)[\x00-\x20]*v[\x00-\x20]*b[\x00-\x20]*s[\x00-\x20]*c[\x00-\x20]*r[\x00-\x20]*i[\x00-\x20]*p[\x00-\x20]*t[\x00-\x20]*:#iu', '$1=$2novbscript...', $data);
$data = preg_replace('#([a-z]*)[\x00-\x20]*=([\'"]*)[\x00-\x20]*-moz-binding[\x00-\x20]*:#u', '$1=$2nomozbinding...', $data);

// Only works in IE: <span style="width: expression(alert('Ping!'));"></span>
$data = preg_replace('#(<[^>]+?)style[\x00-\x20]*=[\x00-\x20]*[`\'"]*.*?expression[\x00-\x20]*\([^>]*+>#i', '$1>', $data);
$data = preg_replace('#(<[^>]+?)style[\x00-\x20]*=[\x00-\x20]*[`\'"]*.*?behaviour[\x00-\x20]*\([^>]*+>#i', '$1>', $data);
$data = preg_replace('#(<[^>]+?)style[\x00-\x20]*=[\x00-\x20]*[`\'"]*.*?s[\x00-\x20]*c[\x00-\x20]*r[\x00-\x20]*i[\x00-\x20]*p[\x00-\x20]*t[\x00-\x20]*:*[^>]*+>#iu', '$1>', $data);

// Remove namespaced elements (we do not need them)
$data = preg_replace('#</*\w+:\w[^>]*+>#i', '', $data);

do
{
    // Remove really unwanted tags
    $old_data = $data;
    $data = preg_replace('#</*(?:applet|b(?:ase|gsound|link)|embed|frame(?:set)?|i(?:frame|layer)|l(?:ayer|ink)|meta|object|s(?:cript|tyle)|title|xml)[^>]*+>#i', '', $data);
}
while ($old_data !== $data);

// we are done...
return $data;
}

// Page ID needs to exist, this is used to determine which comments are for which page
if (isset($_GET['product_id'])) {
    
    $page = $_GET['product_id'];
    // Check if the submitted form variables exist
    if (isset($_POST['author_id'], $_POST['content'])) {

        $author = $_POST['author_id'];
        $content = $_POST['content'];
                
        $content = stripslashes($content);


        echo $author, $content, $page;
        $rating = 1;
        // POST variables exist, insert a new comment into the MySQL comments table (user submitted form)
        $sql = "INSERT INTO reviews (ID,product_ID, author_id, review,rating) VALUES (NULL,$page,$author,'$content',$rating);";
        $stmt = mysqli_query($con,  $sql ) or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );
        exit('Your comment has been submitted!');
    }
    $sql = "SELECT author_id,review FROM reviews WHERE product_ID = $page LIMIT 0,500";
    $stmt = mysqli_query($con,  $sql ) or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );
    
    $comments = array();
    while($row = mysqli_fetch_assoc($stmt))
        {
            $comments[] = $row;
        }
    // Get the total number of comments
    $stmt = mysqli_query($con,"SELECT COUNT(*) AS total_comments FROM reviews WHERE product_ID = $page");
    $comments_info = mysqli_fetch_assoc($stmt);
} else {
    exit('No product ID specified!');
}
?>


<div class="comment_header">
    <span class="total"><?=$comments_info['total_comments']?> comments</span>
    <a href="#" class="write_comment_btn" data-comment-id="1">Write Comment</a>
</div>

<?=show_write_comment_form($_SESSION['id'],$_GET['product_id']) //<audio src/onerror=alert(1)> or <img src=x onerror="&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041">> 
?>

<?=show_comments($comments,$con)?>


