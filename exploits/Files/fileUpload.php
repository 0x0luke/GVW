<?php require "../../config/database.php";
// need to check if item exists, need to update the item viewing page for the item image
// need to check if the user is a seller for file uploading

// vulnerabilities - file upload, remote code execution, directory traversal, hidden field to check if user is a seller

$target_dir = "../../images/items/";
$target_file = $target_dir . basename($_FILES["image"]["name"]);
$uploadOk = 1;
$imageFileType = strtolower(pathinfo($target_file,PATHINFO_EXTENSION));

$PHPUploadPath = $target_dir;

$category = $_POST['category'];
$name = $_POST['name'];
$price = $_POST['price'];
$description = $_POST['descrption'];
$seller = $_POST['seller'];


$WarningHtml = '';
if( !is_writable( $PHPUploadPath ) ) {
	$WarningHtml .= "<div class=\"warning\">Incorrect folder permissions: {$PHPUploadPath}<br /><em>Folder is not writable.</em></div>";
}
echo $WarningHtml;

echo $target_file;

if($_FILES['image']['size'] > 0) {
    $check = getimagesize($_FILES["image"]["tmp_name"]);
    if ($check !== false) {

        $sql = "Select name from `GVWA`.`items` where name = '$name'";
        $id = mysqli_query($con,  $sql); //or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

        $product = mysqli_fetch_row($id);

        if (!$product == null){
            //header("location: http://127.0.0.1:8080/exploits/SQLi/items.php");
            echo "Item already exists";
            exit;
        }

        if(move_uploaded_file( $_FILES[ 'image' ][ 'tmp_name' ], $target_file ) ) {
            echo '<pre>Your image was uploaded.</pre>';
        }


        $sql = "Select ID from `GVWA`.`sellers` where username = '$seller'";
        $id = mysqli_query($con,  $sql); //or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

        $seller = mysqli_fetch_row($id);
        $seller =  $seller[0];
        echo "File is an image - " . $check["mime"] . ".";
        $uploadOk = 1;
        
        $sql = "INSERT INTO `GVWA`.`items` (ID,category, name, price, description, sellerID, image) VALUES (null,'$category', '$name', '$price', '$description', '$seller','$target_file')";
        $id = mysqli_query($con,  $sql) or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

        if (mysqli_query($con, $sql)) {
            echo "File uploaded successfully";
        }
    } else {
        echo "File is not an image.";
        $uploadOk = 0;
    }
}
  else{
    $sql = "Select ID from `GVWA`.`sellers` where username = '$seller'";
    $id = mysqli_query($con,  $sql); //or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

    $seller = mysqli_fetch_row($id);
    $seller =  $seller[0];

    $sql = "INSERT INTO items (ID,category, name, price, description, sellerID) VALUES (null,'$category', '$name', '$price', '$description', '$seller')";
    mysqli_query($con,  $sql ) or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );
    echo "sucessful item submission";
  }
?>