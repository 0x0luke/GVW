<?php include "../../config/database.php";
session_start();

if(isset($_SESSION["error"])){
    $error = $_SESSION["error"];
    echo "<span>$error</span>";
}
$category = mysqli_query($con,"SELECT * FROM `GVWA`.`categories` ORDER BY `categories`.`name` ASC");
#$category = mysqli_fetch_all($category);

#$returnResult = []; //initialise empty array
while($row = $category->fetch_assoc())
{
    $returnResult[] = $row;
}
$category = $returnResult;

// Is PHP function magic_quotee enabled?
$WarningHtml = '';
if( ini_get( 'magic_quotes_gpc' ) == true ) {
	$WarningHtml .= "<div class=\"warning\">The PHP function \"<em>Magic Quotes</em>\" is enabled.</div>";
}
// Is PHP function safe_mode enabled?
if( ini_get( 'safe_mode' ) == true ) {
	$WarningHtml .= "<div class=\"warning\">The PHP function \"<em>Safe mode</em>\" is enabled.</div>";
}
?>

<html>
<body>
<form action="#" method="GET">
<div class="search-box">
    <select id="category" name="category" multiple="multiple">
        <option value="all" selected="selected">All Categories</option>
        <?php
            if (! empty($category)) {
                 foreach ($category as $key => $value) { 
                    echo '<option value="' . implode($category[$key]) . '">' . implode($category[$key]) . '</option>';
                 }
             }
        ?>
    </select>
</div>
    <input type="text" name="query" />
	<input type="submit" value="Search" name="submit" />
    
</form>


    <?php include "../../config/database.php";

if( isset( $_REQUEST[ 'submit' ] ) ) {
	// Get input
    $category = $_REQUEST[ 'category' ];
    $query = $_REQUEST[ 'query' ];

    // Check database
    if ($category != "all") {
        $raw_query =  "SELECT name,price,ID FROM GVWA.items 
        WHERE  ((`name` = '$query') OR (`name` LIKE '%".$query."%') OR (`description` LIKE '%".$query."%')) AND `category` = '$category'";
    } else {
        $raw_query = "SELECT name,price,ID FROM GVWA.items
            WHERE (`name` LIKE '%".$query."%') OR (`description` LIKE '%".$query."%');";
    }
    $raw_results = mysqli_query($con,  $raw_query ) or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

	// Get results
	while( $product_array = mysqli_fetch_assoc( $raw_results ) ) {
		// Get values?>
	<div class="product-item">
		<form method="post" action="../ShoppingCart/updateShoppingCart.php?action=add&code=<?php echo $product_array["ID"]; ?>&price=<?php echo $product_array["price"]; ?>">
		<div class="product-image"><img src="<?php echo $product_array["image"]; ?>"></div>
		<div class="product-tile-footer">

        <div class="product-title"><?php
        $id = $product_array['ID'];
        $name = $product_array['name'];
        echo "<a href = ../XSS/index.php?product_id=$id>$name</a>";?></div>

		<div class="product-price"><?php echo "$".$product_array["price"]; ?></div>
		<div class="cart-action"><input type="text" class="product-quantity" name="quantity" value="1" size="2" /><input type="submit" value="Add to Cart" class="btnAddAction" /></div>
		</div>
		</form>
	</div>
    <?php
	}

	mysqli_close($con);
}

unset($_SESSION["error"]);

?>

<form action="../../config/reload.php?page_name">
    <input type="hidden" value=<?php echo __DIR__;?>/search.php id="page_name" name="page_name"/>
    <input type="submit" value="Reset Search backend" />
</form>

<form action="../../config/reload.php?page_name">
    <input type="hidden" value=<?php echo __FILE__;?> id="page_name" name="page_name"/>
    <input type="submit" value="Reset Search Frontend" />
</form>

<a href="../ShoppingCart/shoppingCart.php">Checkout</a>
</body>
</html>
