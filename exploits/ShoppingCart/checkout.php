<?php require "../../config/database.php";
session_start();

if (isset($_SESSION['seller'])){
    $error = "must be logged as a customer to buy items";
	$_SESSION["error"] = $error;
    header("location: ../SQLi/items.php");
}
$user = $_SESSION['id'];

$stmt = $con->prepare("SELECT * FROM `GVWA`.`customers` WHERE ID = ?");
$stmt->bind_param("i",$user);
$stmt->execute();

$res = $stmt->get_result();
$row = $res->fetch_assoc();

$balance = $row['balance'];

print_r($row);

$fee = 0;

foreach($_SESSION["cart_item"] as $k => $v) {
    $fee = $fee + $v['price'];
}

echo $fee;

$outstanding = $balance - $fee;

if ($outstanding >= 0){
    echo "Order placed";
    $sql = "UPDATE customers
    SET balance = $outstanding
    WHERE ID = $user;";

    $raw_results = mysqli_query($con,  $sql) or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

    $sql = "SELECT * FROM `GVWA`.`customers` WHERE ID = $user";
    $raw_results = mysqli_query($con,  $sql) or die( '<pre>' . ((is_object($con)) ? mysqli_error($con) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );

    $row = mysqli_fetch_assoc($raw_results);
    $balance = $row['balance'];
    echo "New balance is: $balance";
    unset($_SESSION["cart_item"]);

}
else{
    echo "Not enough money";
    echo "Current Balance is: $balance";
}


?>